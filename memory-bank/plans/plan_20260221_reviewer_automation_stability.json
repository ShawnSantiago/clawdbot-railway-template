{
  "plan_id": "plan_20260221_reviewer_automation_stability",
  "created_at_utc": "2026-02-21T03:04:36Z",
  "status": "in_progress",
  "source_request": "Create an implementation plan.",
  "scope": "Stabilize AGENTS.md automated plan-review workflow (Claude primary, Gemini fallback) to reduce false timeout/no-output failures and improve audit visibility.",
  "constraints": [
    "integrations.md is status: partial, so per policy each step confidence is capped at 6/10",
    "context gaps GAP-20260221-001/002 were closed on 2026-02-21T03:27:47Z; false-positive classifier gap GAP-20260221-003 was closed on 2026-02-21T03:34:53Z after parser hardening",
    "workflow must preserve AGENTS-required reviewer ordering and audit logging semantics"
  ],
  "storage_metadata": {
    "plan_file_path": "memory-bank/plans/plan_20260221_reviewer_automation_stability.json",
    "cross_references": [
      {
        "file": "memory-bank/activeContext.md",
        "section": "## Priorities",
        "link_format": "[Plan: plan_20260221_reviewer_automation_stability](memory-bank/plans/plan_20260221_reviewer_automation_stability.json)"
      },
      {
        "file": "memory-bank/progress.md",
        "section": "## Active Plans",
        "link_format": "[Plan: plan_20260221_reviewer_automation_stability](memory-bank/plans/plan_20260221_reviewer_automation_stability.json)"
      }
    ],
    "retention_policy": "archive_after_completion_plus_30_days"
  },
  "audit_retention_policy": {
    "log_location": "audit/",
    "minimum_retention_days": 30,
    "access_control": "project maintainers and approved reviewers",
    "notes": "Retain raw reviewer artifacts alongside summary log lines for post-incident diagnosis."
  },
  "escalation_workflow": {
    "trigger_conditions": [
      "both_reviewers_failed",
      "auth_or_credit_blocker_detected",
      "preflight_validation_failed"
    ],
    "blocking_behavior": "Set plan status to `human_review_needed` and pause execution steps beyond preflight.",
    "notification_channel": "Append explicit escalation entry to `audit/plan_reviews.log` and mirror blocker in `memory-bank/context_gaps_log.md`."
  },
  "root_cause_summary": [
    {
      "id": "RC1",
      "summary": "Claude review runs can be terminated by external timeout before final JSON flush, leaving zero-byte artifacts.",
      "evidence": [
        "audit/plan_reviews.log:1",
        "audit/plan_review_outputs/plan_20260221_railway_reliability_hardening_round1.json",
        ".claude/projects/-home-shawn-projects-clawdbot-railway-template/d08d5953-cd9b-41c8-b03b-36af3e345f2d.jsonl:5"
      ]
    },
    {
      "id": "RC2",
      "summary": "Gemini fallback is blocked by interactive authentication in non-interactive sessions.",
      "evidence": [
        "audit/plan_review_outputs/plan_20260221_railway_reliability_hardening_round2_gemini.txt:3",
        "audit/plan_review_outputs/plan_20260221_railway_reliability_hardening_round2_gemini.txt:11"
      ]
    },
    {
      "id": "RC3",
      "summary": "Current logs do not consistently capture exit code, elapsed time, and output mode, making failures ambiguous.",
      "evidence": [
        "audit/plan_reviews.log:1",
        "audit/plan_reviews.log:2"
      ]
    }
  ],
  "steps": [
    {
      "step": "Step 1 - Define deterministic review-runner contract",
      "description": "Specify one command contract for Claude/Gemini review attempts, timeout behavior, and artifact locations.",
      "target_files": [
        "AGENTS.md",
        "audit/plan_review_outputs/"
      ],
      "changes": [
        "Define required invocation metadata fields: timeout_seconds, output_format, exit_code, elapsed_seconds.",
        "Define expected output artifact naming and minimum content checks."
      ],
      "validation": [
        "Contract can represent success, timeout, auth-required, and quota/credit failures."
      ],
      "risk": "Overly strict contract could block legitimate reviewer output variants.",
      "mitigation": "Keep schema minimal and additive; tolerate optional fields for tool-version differences.",
      "confidence_score": 6,
      "rationale": "Process design work with low technical uncertainty."
    },
    {
      "step": "Step 2 - Implement a scripted Claude plan-review invocation",
      "description": "Create a Node-based runner that executes the Claude reviewer with portable timeout control and explicit output-mode handling.",
      "target_files": [
        "scripts/run-plan-review.mjs"
      ],
      "changes": [
        "Add CLI args for plan path, plan id, timeout, output mode, and round number.",
        "Support `json` and `stream-json` modes; default to stream-json for visibility during long runs.",
        "Persist stdout/stderr and emit machine-readable status summary.",
        "Document and verify Claude API credential/account preconditions before execution; block Step 2 when preconditions fail.",
        "Document expected stream-json event schema and terminal result-event requirements for pass/fail classification.",
        "Define minimum viable partial-output evidence (at least one valid stream event with reviewer context) for timeout escalations.",
        "Add bounded retry behavior for transient API failures (e.g., 429/503 with capped retries and backoff).",
        "Handle partial stream-json output safely on timeout by preserving newline-delimited event logs and validating complete final-result events separately."
      ],
      "validation": [
        "Dry run with short prompt succeeds.",
        "Credential/account preflight is logged with deterministic pass/fail result before primary invocation.",
        "Run parser dry-run against success, timeout, and partial-output fixtures and document known failure modes.",
        "Forced short timeout records timeout classification and non-zero exit code.",
        "Event-schema checks distinguish valid partial event logs from malformed output.",
        "Partial stream output remains parseable for diagnostics even when final result event is absent."
      ],
      "risk": "Incomplete parser rules can misclassify partial stream output as malformed data.",
      "mitigation": "Treat stream event logs as append-only evidence, and only require strict JSON validation for terminal `result` events.",
      "confidence_score": 4,
      "rationale": "Implementation is straightforward but robust partial-output handling needs careful edge-case checks."
    },
    {
      "step": "Step 3 - Implement explicit Gemini fallback handling",
      "description": "Add fallback execution path with pre-flight auth detection, explicit fallback trigger rules, and manual-approval escalation output.",
      "target_files": [
        "scripts/run-plan-review.mjs",
        "audit/plan_reviews.log"
      ],
      "changes": [
        "Add staged pre-flight checks: (1) CLI executable availability, (2) non-interactive capability probe, (3) account/auth readiness check, and (4) explicit failure-signature mapping.",
        "Specify Gemini non-interactive auth mechanism requirement (or explicit manual-review fallback when non-interactive auth is unavailable).",
        "Attempt Gemini only when fallback decision-matrix allows it.",
        "Detect auth prompts/timeouts and classify as fallback_failed with explicit reason."
      ],
      "validation": [
        "Execute pre-flight matrix for Claude and Gemini paths and write outcomes to `audit/plan_review_outputs/preflight_validation_YYYYMMDD.log` with exit codes and stderr captures.",
        "Fallback path logs a concrete classification when auth is required.",
        "Fallback trigger matrix is applied consistently for timeout/empty-output/nonzero/auth outcomes.",
        "Pre-flight stage outputs are independently testable and logged with deterministic stage identifiers.",
        "Human-review-needed escalation entry is emitted when both attempts fail or fallback is blocked by pre-flight."
      ],
      "risk": "Pattern matching on CLI output may be brittle across tool versions.",
      "mitigation": "Prefer exit-code and explicit pre-flight result signals first; use conservative text matching only as a secondary classifier and retain raw artifacts.",
      "confidence_score": 3,
      "rationale": "Fallback logic depends on external CLI messaging that can drift."
    },
    {
      "step": "Step 4 - Upgrade audit logging and gap linkage",
      "description": "Standardize audit entries and tie failures to context gaps with reproducible evidence links.",
      "target_files": [
        "audit/plan_reviews.log",
        "memory-bank/context_gaps_log.md"
      ],
      "changes": [
        "Include timeout_seconds, elapsed_seconds, exit_code, and output artifact path in each log line.",
        "Add/refresh gap references with exact evidence files for unresolved automation blockers."
      ],
      "validation": [
        "Each failed run has enough data to distinguish timeout vs auth vs credit/quota causes."
        ,
        "Existing audit log readers (if any) continue to parse one-line entries after additive metadata changes."
      ],
      "risk": "Log verbosity may make manual scanning harder.",
      "mitigation": "Keep one-line summary format and add only high-value metadata fields.",
      "confidence_score": 5,
      "rationale": "Low implementation complexity with moderate consistency risk."
    },
    {
      "step": "Step 5 - Update AGENTS workflow guidance",
      "description": "Document operational defaults that prevent false no-output failures.",
      "target_files": [
        "AGENTS.md"
      ],
      "changes": [
        "Set recommended timeout window for plan reviews (e.g., >=600s).",
        "Base timeout guidance on observed audit runtimes (median/p95 + explicit safety buffer).",
        "Document when to use stream-json mode and how to interpret zero-byte JSON outputs.",
        "Document stuck-vs-slow heuristics using streamed event cadence and elapsed time thresholds.",
        "Document mandatory capture of stderr/stdout artifacts before escalation."
      ],
      "validation": [
        "Guidance aligns with actual script behavior and audit fields."
      ],
      "risk": "Policy text can diverge from implemented scripts over time.",
      "mitigation": "Reference script flags directly in AGENTS examples to reduce drift.",
      "confidence_score": 5,
      "rationale": "Documentation update is direct but requires consistency checks."
    },
    {
      "step": "Step 6 - End-to-end rehearsal and acceptance criteria",
      "description": "Run a controlled rehearsal to verify reviewer automation behavior and acceptance paths.",
      "target_files": [
        "audit/plan_review_outputs/",
        "audit/plan_reviews.log",
        "memory-bank/progress.md"
      ],
      "changes": [
        "Execute one success-path smoke run and one forced-timeout run.",
        "Execute one auth-gated fallback scenario to verify non-interactive escalation behavior OR validate that gap-closure evidence already satisfies auth-failure classification coverage.",
        "Confirm classifications, artifacts, and escalation outputs are correct.",
        "Record acceptance results and residual blockers in progress and context gaps."
      ],
      "acceptance_levels": {
        "minimal_acceptance": [
          "Success-path run returns exit_code=0, output_file_size_bytes>0, and a complete terminal result event in output artifact (1/1 required).",
          "Timeout path classification tests pass for both `timeout_no_output` and `timeout_partial_output` fixtures (2/2 required).",
          "Auth/account failure signatures are classified deterministically with explicit error keys (`auth_required`, `credit_balance_low`, or `quota_exceeded`) even if unresolved (3/3 required)."
        ],
        "full_acceptance": [
          "All minimal acceptance checks pass.",
          "Fallback execution path completes with exit_code=0 when pre-flight is green, or blocker is explicitly documented as persistent external constraint with GAP-ID linkage."
        ]
      },
      "validation": [
        "Success path: exit_code=0 with non-empty reviewer output artifact and complete terminal result event.",
        "Timeout path: process terminates at configured timeout and classification distinguishes timeout_no_output vs timeout_partial_output.",
        "Auth path: pre-flight detects interactive-auth requirement and logs deterministic escalation outcome.",
        "Credit/account failure path is classified distinctly from transport timeout.",
        "Minimal acceptance threshold is met only when 3/3 minimal checks pass."
      ],
      "risk": "External service conditions (auth/quota/network) can block rehearsal completion.",
      "mitigation": "Allow manual approval fallback and keep blocker gaps open with concrete evidence.",
      "confidence_score": 3,
      "rationale": "Depends on external service availability and account state."
    }
  ],
  "risks": [
    {
      "description": "Longer timeouts may hide genuinely stuck executions.",
      "mitigation": "Require streamed progress output and elapsed-time logging to differentiate slow vs stuck runs."
    },
    {
      "description": "Reviewer CLI auth/credit state may remain unavailable despite process fixes.",
      "mitigation": "Keep explicit human-approval fallback path and maintain open gap tracking until resolved."
    },
    {
      "description": "Audit schema changes can break downstream manual habits.",
      "mitigation": "Preserve existing one-line format and append metadata fields rather than replacing schema."
    }
  ],
  "fallback_decision_matrix": {
    "claude_timeout": "fallback_to_gemini",
    "claude_timeout_no_output": "fallback_to_gemini",
    "claude_timeout_partial_output": "fallback_to_gemini",
    "claude_empty_output_nonzero": "fallback_to_gemini",
    "claude_generic_nonzero": "fallback_to_gemini",
    "claude_auth_failure": "escalate_human_review_needed",
    "claude_credit_or_quota_failure": "escalate_human_review_needed",
    "gemini_auth_required": "escalate_human_review_needed",
    "both_failed": "escalate_human_review_needed"
  },
  "rollback_strategy": [
    "Trigger rollback if two consecutive plan-review runs produce false-negative classifications or parser failures after deployment.",
    "Revert review-runner script and AGENTS command examples to prior known-good revision and log rollback timestamp in `audit/plan_reviews.log`.",
    "Temporarily return to manual reviewer invocation while retaining improved audit metadata fields.",
    "Keep context gaps open and require explicit human approval until automation is stable."
  ],
  "overall_confidence": {
    "score": 5,
    "rationale": "Plan quality improved and known automation gaps are now closed, but `integrations.md` remains partial and forced-timeout/fallback acceptance checks are still pending."
  },
  "review_automation": {
    "status": "approved_with_revisions",
    "attempts": [
      {
        "reviewer": "claude-plan-reviewer",
        "iteration": 1,
        "result": "claude_failed",
        "timestamp_utc": "2026-02-21T03:07:28Z",
        "evidence": "audit/plan_reviews.log"
      },
      {
        "reviewer": "gemini-plan-reviewer",
        "iteration": 2,
        "result": "fallback_failed",
        "timestamp_utc": "2026-02-21T03:07:29Z",
        "evidence": "audit/plan_reviews.log"
      },
      {
        "reviewer": "claude-plan-reviewer",
        "iteration": 3,
        "result": "approved_with_revisions",
        "timestamp_utc": "2026-02-21T03:12:02Z",
        "evidence": "audit/plan_reviews.log"
      },
      {
        "reviewer": "claude-plan-reviewer",
        "iteration": 4,
        "result": "approved_with_revisions",
        "timestamp_utc": "2026-02-21T03:17:07Z",
        "evidence": "audit/plan_reviews.log"
      },
      {
        "reviewer": "claude-plan-reviewer",
        "iteration": 5,
        "result": "approved_with_revisions",
        "timestamp_utc": "2026-02-21T03:18:59Z",
        "evidence": "audit/plan_reviews.log"
      },
      {
        "reviewer": "claude-plan-reviewer",
        "iteration": 6,
        "result": "approved_with_revisions",
        "timestamp_utc": "2026-02-21T03:21:41Z",
        "evidence": "audit/plan_reviews.log"
      },
      {
        "reviewer": "claude-plan-reviewer",
        "iteration": 7,
        "result": "approved_with_revisions",
        "timestamp_utc": "2026-02-21T03:27:30Z",
        "evidence": "audit/plan_reviews.log"
      },
      {
        "reviewer": "claude-plan-reviewer",
        "iteration": 8,
        "result": "claude_failed",
        "timestamp_utc": "2026-02-21T03:32:12Z",
        "evidence": "audit/plan_reviews.log",
        "notes": "False-positive `claude_credit_or_quota_failure` due broad keyword matching in stream-json output."
      },
      {
        "reviewer": "claude-plan-reviewer",
        "iteration": 9,
        "result": "approved_with_revisions",
        "timestamp_utc": "2026-02-21T03:34:53Z",
        "evidence": "audit/plan_reviews.log",
        "notes": "Validated classifier fix that reads terminal `type:result` event before applying failure signatures."
      }
    ],
    "gap_ids": [
      "GAP-20260221-001",
      "GAP-20260221-002",
      "GAP-20260221-003"
    ]
  }
}
